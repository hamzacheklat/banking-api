import requests
import uuid
import json
from tqdm import tqdm
from embedder import embed_texts
from vector_store import get_collection
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ‚öôÔ∏è Param√®tres (tu peux ensuite les d√©placer dans config.py)
DELPHIX_BASE_URL = "https://uk271.delphix.xmp.net.intra"
DELPHIX_USER = "admin"
DELPHIX_PASSWORD = "password"

# ‚úÖ Endpoints connus et stables de Delphix
DELPHIX_ENDPOINTS = [
    "environment",
    "repository",
    "sourceconfig",
    "source",
    "database",
    "snapshot",
    "system",
    "job",
    "type"  # <-- option 4 ajout√©e ici
]

def delphix_login():
    sess = requests.Session()
    sess.verify = False

    # 1Ô∏è‚É£ Cr√©ation de session API
    sess.post(f"{DELPHIX_BASE_URL}/resources/json/delphix/session", json={
        "type": "APISession",
        "version": {"type": "APIVersion", "major": 1, "minor": 10, "micro": 0}
    })

    # 2Ô∏è‚É£ Login utilisateur
    payload = {"type": "LoginRequest", "username": DELPHIX_USER, "password": DELPHIX_PASSWORD}
    r = sess.post(f"{DELPHIX_BASE_URL}/resources/json/delphix/login", json=payload)
    if r.status_code != 200:
        raise Exception(f"Erreur de login Delphix ({r.status_code}): {r.text}")

    print("‚úÖ Connect√© √† Delphix API")
    return sess

def fetch_endpoint(sess, endpoint):
    """Appelle un endpoint Delphix, renvoie le JSON brut (ou None si non dispo)."""
    url = f"{DELPHIX_BASE_URL}/resources/json/delphix/{endpoint}"
    r = sess.get(url)
    if r.status_code == 404:
        print(f"‚ö†Ô∏è Endpoint '{endpoint}' introuvable (404).")
        return None
    if r.status_code >= 400:
        print(f"‚ö†Ô∏è Erreur sur {endpoint}: {r.status_code}")
        return None
    try:
        return json.dumps(r.json(), indent=2)
    except Exception:
        return r.text

def ingest_delphix_api():
    """Ingestion compl√®te de la documentation et des objets Delphix."""
    sess = delphix_login()
    collection = get_collection()

    all_docs, metadatas, ids = [], [], []

    for ep in tqdm(DELPHIX_ENDPOINTS, desc="üìò R√©cup√©ration des endpoints Delphix"):
        content = fetch_endpoint(sess, ep)
        if not content:
            continue
        ids.append(str(uuid.uuid4()))
        all_docs.append(content)
        metadatas.append({
            "source": "delphix_api",
            "endpoint": ep
        })

    if not all_docs:
        print("‚ö†Ô∏è Aucune donn√©e r√©cup√©r√©e depuis Delphix.")
        return

    print(f"üß† G√©n√©ration des embeddings pour {len(all_docs)} documents...")
    embeddings = embed_texts(all_docs)
    collection.add(
        ids=ids,
        documents=all_docs,
        embeddings=embeddings,
        metadatas=metadatas
    )
    print("‚úÖ Ingestion compl√®te Delphix (API + Types) termin√©e.")
    sess.close()

if __name__ == "__main__":
    ingest_delphix_api()
