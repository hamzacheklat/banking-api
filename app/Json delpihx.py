import requests
import uuid
import json
from tqdm import tqdm
from embedder import embed_texts
from vector_store import get_collection
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# ‚öôÔ∏è Param√®tres
DELPHIX_BASE_URL = "https://uk271.delphix.xmp.net.intra"
DELPHIX_USER = "admin"
DELPHIX_PASSWORD = "password"

def delphix_login():
    """Connexion √† l'API Delphix et cr√©ation de session."""
    sess = requests.Session()
    sess.verify = False

    # Cr√©ation de session API
    sess.post(f"{DELPHIX_BASE_URL}/resources/json/delphix/session", json={
        "type": "APISession",
        "version": {"type": "APIVersion", "major": 1, "minor": 10, "micro": 0}
    })

    # Login utilisateur
    payload = {"type": "LoginRequest", "username": DELPHIX_USER, "password": DELPHIX_PASSWORD}
    r = sess.post(f"{DELPHIX_BASE_URL}/resources/json/delphix/login", json=payload)
    if r.status_code != 200:
        raise Exception(f"Erreur de login Delphix ({r.status_code}): {r.text}")

    print("‚úÖ Connect√© √† Delphix API")
    return sess

def fetch_api_doc(sess):
    """R√©cup√®re la documentation compl√®te des endpoints depuis /api/json/delphix.json"""
    doc_url = f"{DELPHIX_BASE_URL}/api/json/delphix.json"
    r = sess.get(doc_url)
    if r.status_code != 200:
        raise Exception(f"Impossible de r√©cup√©rer la doc API ({r.status_code}): {r.text}")
    return r.json()

def ingest_delphix_doc():
    """Ingestion de la documentation Delphix API dans le vector store."""
    sess = delphix_login()
    collection = get_collection()

    doc_json = fetch_api_doc(sess)

    all_docs, metadatas, ids = [], [], []

    # Parcours des endpoints document√©s
    for endpoint, details in tqdm(doc_json.items(), desc="üìò R√©cup√©ration de la doc API"):
        # Cr√©e un texte clair pour RAG : description + param√®tres
        content_lines = [f"Endpoint: {endpoint}"]
        if "description" in details:
            content_lines.append(f"Description: {details['description']}")
        if "parameters" in details and details["parameters"]:
            content_lines.append("Param√®tres:")
            for param in details["parameters"]:
                pname = param.get("name", "")
                pdesc = param.get("description", "")
                ptype = param.get("type", "")
                content_lines.append(f"  - {pname} ({ptype}): {pdesc}")
        if "response" in details:
            content_lines.append("R√©ponse JSON (sch√©ma):")
            content_lines.append(json.dumps(details["response"], indent=2))
        content = "\n".join(content_lines)

        ids.append(str(uuid.uuid4()))
        all_docs.append(content)
        metadatas.append({
            "source": "delphix_api_doc",
            "endpoint": endpoint
        })

    if not all_docs:
        print("‚ö†Ô∏è Aucune documentation r√©cup√©r√©e.")
        return

    print(f"üß† G√©n√©ration des embeddings pour {len(all_docs)} documents...")
    embeddings = embed_texts(all_docs)
    collection.add(
        ids=ids,
        documents=all_docs,
        embeddings=embeddings,
        metadatas=metadatas
    )
    print("‚úÖ Ingestion compl√®te de la documentation Delphix API termin√©e.")
    sess.close()

if __name__ == "__main__":
    ingest_delphix_doc()
